# Hướng dẫn triển khai tính năng tự động điều chỉnh bid cho từ khóa

Tài liệu này mô tả các bước xây dựng chức năng tự động thay đổi bid khi từ khóa thỏa mãn các điều kiện đặt ra. Quy trình được chia thành nhiều giai đoạn từ backend đến giao diện người dùng.

## 1. Xây dựng **rules engine** chạy nền

Rules engine đảm nhận việc đánh giá điều kiện và thực thi hành động theo lịch.

1. Thêm bảng `automation_rules` và `automation_logs` trong PostgreSQL để lưu cấu hình luật và lịch sử thay đổi.
2. Tạo service `backend/services/rulesEngine.js` sử dụng bộ lập lịch nội bộ (`setInterval`):
   - Service sẽ tự động chạy định kỳ (ví dụ: mỗi giờ một lần).
   - Lấy danh sách luật đang bật (`is_active=true`).
   - Truy vấn dữ liệu hiệu suất từ `sponsored_products_search_term_report`.
   - Đánh giá điều kiện theo JSON `conditions`.
   - Thực thi `actions` (tăng/giảm bid, pause...).
   - Ghi log vào `automation_logs` và cập nhật `last_run_at`.
3. Import và khởi động service trong `backend/server.js` để rules engine hoạt động cùng server.

## 2. Gọi Amazon Ads API để thay đổi bid

Sau khi rules engine xác định hành động, cần gửi yêu cầu cập nhật lên Amazon Ads API.

1. Trong `rulesEngine.js`, xây dựng payload `updates` chứa `keywordId`, `bid` mới và `state` nếu cần.
2. Sử dụng helper `amazonAdsApiRequest` với phương thức `PUT` tới `/sp/keywords`:
   ```js
   amazonAdsApiRequest({
     method: 'put',
     url: '/sp/keywords',
     profileId,
     data: { keywords: updates }
   })
   ```
3. Xử lý lỗi trả về, ghi lại bid cũ và mới trong `automation_logs` khi cập nhật thành công.

## 3. Sử dụng dữ liệu hiệu suất để xét điều kiện

Dữ liệu Search Term Report cung cấp các chỉ số như spend, clicks và ACOS dùng để kích hoạt luật.

1. Viết hàm truy vấn bảng `sponsored_products_search_term_report` cho các ngày cách hiện tại ít nhất 3 ngày (dữ liệu tổng hợp trễ 3 ngày). Với 3 ngày gần nhất, lấy số liệu từ bảng stream `raw_stream_events` và gộp vào kết quả.
2. Tính toán KPI: ACOS, ROAS, CTR... trong service.
3. So sánh các KPI với `conditions` của từng luật (ví dụ `ACOS > 0.4` và `clicks > 10`).

### Ví dụ rule minh họa

```json
{
  "name": "Giảm bid khi ACOS cao",
  "conditions": [
    { "field": "acos", "operator": ">", "value": 0.4 },
    { "field": "clicks", "operator": ">", "value": 10 }
  ],
  "actions": [
    { "type": "adjustBidPercent", "value": -20 }
  ]
}
```

Rule trên giảm 20% bid của keyword nếu ACOS lớn hơn 40% và có hơn 10 lượt nhấp trong khoảng thời gian được phân tích.

### Ý tưởng rule chi tiết

Rule sau minh họa cách giảm bid linh hoạt dựa trên chênh lệch ACOS so với mục tiêu, đồng thời kiểm soát bước điều chỉnh và tần suất đánh giá.

```json
{
  "name": "Giảm bid theo chênh lệch ACOS",
  "targetAcos": 0.4,
  "min_step": 0.05,
  "max_step": 0.2,
  "lookback_days": 7,
  "cooldown_hours": 24,
  "conditions": [
    { "field": "clicks", "operator": ">", "value": 5 }
  ]
}
```

**Quy trình thực thi**

1. Bỏ qua luật nếu lần chạy gần nhất chưa vượt `cooldown_hours`.
2. Lấy dữ liệu hiệu suất trong `lookback_days` ngày gần nhất và tính ACOS thực tế.
3. Nếu `ACOS > targetAcos` và đủ số clicks, tính phần trăm điều chỉnh:
   ```js
   const delta = (acos - targetAcos) / targetAcos;
   const step = clamp(Math.abs(delta), min_step, max_step);
   const newBid = currentBid * (1 - step);
   ```
4. Gửi bid mới lên Amazon Ads API và ghi log kết quả.

Cách tiếp cận này giúp tránh thay đổi quá mạnh khi dữ liệu ít, đồng thời phản ứng linh hoạt với mức chênh lệch ACOS.

## 4. Kiến trúc luật Nâng cao: IF / OR IF / THEN với Quy tắc Ưu tiên

Để xây dựng các chiến lược phức tạp, hệ thống hỗ trợ một kiến trúc luật nâng cao, nơi mỗi luật có thể chứa nhiều nhóm điều kiện (`Condition Group`), hoạt động giống như một chuỗi `IF / ELSE IF / ELSE IF`.

### 4.1 Cấu trúc

Mỗi luật bao gồm một danh sách các "Nhóm điều kiện". Mỗi nhóm này có 2 phần:
- **IF**: Một hoặc nhiều điều kiện được kết nối bằng logic **AND**. Tất cả phải đúng.
- **THEN**: Một hành động cụ thể sẽ được thực thi **chỉ khi** nhóm điều kiện đó được thỏa mãn.

**Ví dụ một luật có 2 nhóm điều kiện:**

- **IF (Nhóm 1)**
    - `Spend (60 ngày) > $20` **AND**
    - `Sales (60 ngày) = 0`
    - **THEN: Giảm Bid đi 25%**
- **OR (Nhóm 2)**
    - `ACOS (60 ngày) > 35%` **AND**
    - `ACOS (14 ngày) > 35%`
    - **THEN: Giảm Bid đi 5%**

### 4.2 Nguyên tắc thực thi: "First Match Wins" (Luật khớp đầu tiên được áp dụng)

Đây là nguyên tắc cốt lõi để giải quyết sự chồng chéo và xung đột giữa các nhóm điều kiện.

1.  **Thứ tự là trên hết:** Hệ thống sẽ luôn đánh giá các nhóm điều kiện theo thứ tự bạn sắp xếp chúng trong giao diện, **từ trên xuống dưới**.
2.  **Dừng lại khi tìm thấy:** Ngay khi một từ khóa thỏa mãn **tất cả** các điều kiện `AND` bên trong một nhóm, hệ thống sẽ thực hiện hành động `THEN` của **chỉ nhóm đó** và **ngừng xử lý** từ khóa đó. Nó sẽ không xét đến các nhóm bên dưới nữa.

**Áp dụng vào ví dụ trên:**
Nếu một từ khóa có `Spend (60 ngày) = $25` và `Sales (60 ngày) = 0`, nó sẽ khớp với **Nhóm 1**. Hệ thống sẽ giảm bid 25% và **sẽ không kiểm tra Nhóm 2 nữa**, dù từ khóa đó có thể cũng thỏa mãn điều kiện của Nhóm 2.

### 4.3 Tầm quan trọng của việc sắp xếp

Vì nguyên tắc "First Match Wins", thứ tự của các nhóm điều kiện là cực kỳ quan trọng. Bạn phải sắp xếp các luật của mình một cách có chiến lược.

> **Quy tắc vàng:** Đặt các luật **cụ thể nhất** và có mức độ ưu tiên cao nhất (ví dụ: giảm bid mạnh nhất) ở trên cùng. Các luật chung chung hơn nên được đặt ở dưới.

**Ví dụ về việc sắp xếp SAI:**

1.  `IF ACOS (14 ngày) > 30%` **THEN** `Giảm bid 5%` (Luật chung chung)
2.  `OR IF ACOS (14 ngày) > 30%` **AND** `Spend (14 ngày) > $50` **THEN** `Giảm bid 20%` (Luật cụ thể hơn)

Nếu một từ khóa có `ACOS = 35%` và `Spend = $60`, nó sẽ chỉ bị giảm 5% vì nó đã khớp với luật đầu tiên, và hệ thống sẽ không bao giờ xét đến luật thứ hai mạnh hơn.

**Ví dụ về việc sắp xếp ĐÚNG:**

1.  `IF ACOS (14 ngày) > 30%` **AND** `Spend (14 ngày) > $50` **THEN** `Giảm bid 20%`
2.  `OR IF ACOS (14 ngày) > 30%` **THEN** `Giảm bid 5%`

Với cách sắp xếp này, từ khóa có hiệu suất tệ nhất sẽ bị xử lý bởi luật mạnh nhất trước tiên.

## 5. Tự động xử lý **search term**

Ngoài việc điều chỉnh bid, rules engine có thể tự động quản lý search term để tiết kiệm chi phí và mở rộng quảng cáo.

### 5.1 Nguyên lý

1. Thu thập dữ liệu hiệu suất cho từng search term trong `lookback_days` do người dùng cấu hình.
2. Nếu search term **tốn chi phí nhưng không hiệu quả** → chuyển thành negative.
3. Nếu search term **có đơn hàng tốt** → tạo keyword mới với `initial_bid` tùy biến.
4. Ghi lại mọi hành động vào `automation_logs`.

### 5.2 Ví dụ rule (giá trị người dùng tùy chỉnh)

```json
{
  "name": "Quản lý search term",
  "lookback_days": "<LOOKBACK_DAYS>",
  "conditions": [
    { "field": "clicks", "operator": ">", "value": "<MIN_CLICKS>" },
    { "field": "sales", "operator": "=", "value": 0 },
    { "field": "spend", "operator": ">", "value": "<MAX_SPEND>" }
  ],
  "negativeAction": { "matchType": "negativeExact" },
  "promotionCriteria": [
    { "field": "orders", "operator": ">=", "value": "<MIN_ORDERS>" },
    { "field": "acos", "operator": "<", "value": "<MAX_ACOS>" }
  ],
  "promotionAction": { "initial_bid": "<INITIAL_BID>" },
  "cooldown_hours": "<COOLDOWN_HOURS>"
}
```

**Luồng xử lý**

1. Bỏ qua rule nếu còn trong thời gian `cooldown_hours`.
2. Với search term thỏa `conditions`, gọi Amazon Ads API `/sp/negativeKeywords` để gắn negative.
3. Với search term thỏa `promotionCriteria`, gọi `/sp/keywords` tạo keyword mới cùng `initial_bid`.
4. Ghi log chi tiết hành động, bid cũ/mới và search term liên quan.

## 6. Giao diện quản lý và log

### 6.1 Form cấu hình rule

Giao diện `views/AutomationView.tsx` cho phép **tạo nhiều rule** cho từng loại automation. Mỗi tab bao gồm danh sách các rule đã có cùng nút **New Rule** để thêm rule mới.

- **Bid Adjustment**: cấu hình các rule điều chỉnh bid với các trường `targetAcos`, `min_step`, `max_step`, `lookback_days`, `cooldown_hours`…
- **Search Term Automation**: cấu hình các rule xử lý search term với `lookback_days`, `min_clicks`, `max_spend`, `max_acos`, `min_orders`, `initial_bid`, `cooldown_hours`…

Các trường đều là input để người dùng tự đặt giá trị. Rule builder hiển thị phần IF/THEN trực quan và cho phép quản lý nhiều rule độc lập.

### 6.2 Hiển thị log trên frontend

1. Tạo `views/AutomationLogView.tsx` đọc dữ liệu từ `/api/automation/logs`.
2. Log table hiển thị loại hành động (adjust bid, negative, promote), keyword/search term liên quan, bid cũ/mới, thời gian thực thi và trạng thái thành công/ thất bại.
3. Cung cấp bộ lọc theo loại rule, chiến dịch hoặc khoảng thời gian để dễ tra cứu.

### 6.3 Chọn rule trong tab **PPC Management**

Trong bảng quản lý PPC, thêm hai cột mới để gán rule cho từng chiến dịch:

- **Bid Adjustment Rule**: dropdown hiển thị danh sách các rule điều chỉnh bid đã tạo.
- **Search Term Auto Rule**: dropdown hiển thị các rule tự động xử lý search term.

Người dùng chọn rule mong muốn cho mỗi chiến dịch; hệ thống sẽ lưu ID rule tương ứng để rules engine áp dụng.

## 7. Mở rộng chiến lược tối ưu bid

Sau khi hệ thống cơ bản hoạt động, có thể nâng cao khả năng tối ưu.

1. Thu thập lịch sử KPI dài hạn để phân tích xu hướng.
2. Xây dựng module thử nghiệm (A/B) hoặc mô hình máy học dự đoán hiệu quả keyword.
3. Tích hợp kết quả dự đoán vào `rulesEngine.js` để cập nhật bid linh hoạt hơn.

---

Hoàn thành các bước trên sẽ giúp tự động hóa việc điều chỉnh bid, giảm thao tác thủ công và tối ưu hiệu suất quảng cáo một cách liên tục.